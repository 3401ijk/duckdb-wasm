name: 'Benchmarks'
on:
    workflow_dispatch:

jobs:
    tpchgen:
        name: TPCH Generator
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: 'recursive'

            - name: Cache generator
              uses: actions/cache@v2
              id: cache-generator
              with:
                  path: ./submodules/tpch-dbgen/dbgen/dbgen
                  key: ${{ runner.os }}-tpch-dben

            - name: Build generator
              if: steps.cache-generator.outputs.cache-hit != 'true'
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      make -C ./submodules/tpch-dbgen/dbgen/ dbgen

            - name: Upload artifact
              uses: actions/upload-artifact@v2
              with:
                  name: tpch-dbgen
                  path: |
                      ./submodules/tpch-dbgen/dbgen/dbgen
                  retention-days: 1

    dataprep:
        name: Dataprep
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: 'recursive'

            - name: Cache rust build
              uses: actions/cache@v2
              with:
                  path: |
                      ./.cargo
                      ./target
                  key: ${{ runner.os }}-dataprep-${{ hashFiles('./Cargo.lock') }}-${{ hashFiles('./tools/dataprep/src/*.rs') }}
                  restore-keys: |
                      ${{ runner.os }}-dataprep-

            - name: Build generator
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      cargo build --manifest-path=./Cargo.toml --release -p dataprep

            - name: Upload artifact
              uses: actions/upload-artifact@v2
              with:
                  name: dataprep
                  path: |
                      ./target/release/dataprep
                  retention-days: 1

    duckdb_shell:
        name: DuckDB Shell
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: 'recursive'

            - name: Git submodule status
              run: |
                  git submodule status ./submodules/duckdb > git_submodule_status.txt

            - name: Cache ccache
              uses: actions/cache@v2
              with:
                  path: |
                      ./.ccache
                  key: ${{ runner.os }}-duckdb-${{ hashFiles('git_submodule_status.txt') }}
                  restore-keys: |
                      ${{ runner.os }}-duckdb-

            - name: Build DuckDB shell
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      ccache -z
                      ./scripts/build_duckdb_shell.sh
                      ccache -s

            - name: Upload artifact
              uses: actions/upload-artifact@v2
              with:
                  name: duckdb-shell
                  path: ./submodules/duckdb/build/Release/duckdb
                  retention-days: 1

    wasm_default:
        name: WASM / Default
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: 'recursive'
                  fetch-depth: 0

            - name: Git submodule status
              run: |
                  git submodule status > git_submodule_status.txt

            - name: Cache WASM build
              uses: actions/cache@v2
              with:
                  path: |
                      ./.emscripten_cache
                      ./.ccache
                  key: ${{ runner.os }}-wasm6-default-${{ hashFiles('git_submodule_status.txt') }}-${{ hashFiles('lib/src/**') }}-${{ hashFiles('lib/include/**') }}
                  restore-keys: |
                      ${{ runner.os }}-wasm6-default-${{ hashFiles('git_submodule_status.txt') }}
                      ${{ runner.os }}-wasm6-default-

            - name: Prepare repository
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      ccache --max-size 300M
                      ccache -s
                      (cd ./submodules/duckdb && git fetch --tags)

            - name: Build WASM module
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      ccache -z
                      ./scripts/wasm_build_lib.sh release default
                      ccache -s

            - name: Upload artifact
              uses: actions/upload-artifact@v2
              with:
                  name: wasm-default
                  path: |
                      ./packages/duckdb-wasm/src/bindings/duckdb_wasm.js
                      ./packages/duckdb-wasm/src/bindings/duckdb_wasm.wasm
                  retention-days: 1

    wasm_next:
        name: WASM / Next
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: 'recursive'
                  fetch-depth: 0

            - name: Git submodule status
              run: |
                  git submodule status > git_submodule_status.txt

            - name: Cache WASM build
              uses: actions/cache@v2
              with:
                  path: |
                      ./.emscripten_cache
                      ./.ccache
                  key: ${{ runner.os }}-wasm6-next-${{ hashFiles('git_submodule_status.txt') }}-${{ hashFiles('lib/src/**') }}-${{ hashFiles('lib/include/**') }}
                  restore-keys: |
                      ${{ runner.os }}-wasm6-next-${{ hashFiles('git_submodule_status.txt') }}
                      ${{ runner.os }}-wasm6-next-

            - name: Prepare repository
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      ccache --max-size 300M
                      ccache -s
                      (cd ./submodules/duckdb && git fetch --tags)

            - name: Build WASM module
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      ccache -z
                      ./scripts/wasm_build_lib.sh release next
                      ccache -s

            - name: Upload artifact
              uses: actions/upload-artifact@v2
              with:
                  name: wasm-next
                  path: |
                      ./packages/duckdb-wasm/src/bindings/duckdb_wasm_next.js
                      ./packages/duckdb-wasm/src/bindings/duckdb_wasm_next.wasm
                  retention-days: 1

    wasm_next_coi:
        name: WASM / Next COI
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: 'recursive'
                  fetch-depth: 0

            - name: Git submodule status
              run: |
                  git submodule status > git_submodule_status.txt

            - name: Cache WASM build
              uses: actions/cache@v2
              with:
                  path: |
                      ./.emscripten_cache
                      ./.ccache
                  key: ${{ runner.os }}-wasm6-next-coi-${{ hashFiles('git_submodule_status.txt') }}-${{ hashFiles('lib/src/**') }}-${{ hashFiles('lib/include/**') }}
                  restore-keys: |
                      ${{ runner.os }}-wasm6-next-coi-${{ hashFiles('git_submodule_status.txt') }}
                      ${{ runner.os }}-wasm6-next-coi-

            - name: Prepare repository
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      ccache --max-size 300M
                      ccache -s
                      (cd ./submodules/duckdb && git fetch --tags)

            - name: Build WASM module
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      ccache -z
                      ./scripts/wasm_build_lib.sh release next_coi
                      ccache -s

            - name: Upload artifact
              uses: actions/upload-artifact@v2
              with:
                  name: wasm-next-coi
                  path: |
                      ./packages/duckdb-wasm/src/bindings/duckdb_wasm_next_coi.js
                      ./packages/duckdb-wasm/src/bindings/duckdb_wasm_next_coi.pthread.js
                      ./packages/duckdb-wasm/src/bindings/duckdb_wasm_next_coi.wasm
                  retention-days: 1

    benchmarks_simple:
        name: Simple Benchmarks
        runs-on: ubuntu-latest
        needs:
            - dataprep
            - tpchgen
            - duckdb_shell
            - wasm_default
            - wasm_next
            - wasm_next_coi
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: 'recursive'
                  fetch-depth: 0

            - name: Cache node_modules
              uses: actions/cache@v2
              with:
                  path: |
                      ./node_modules
                      ./packages/benchmarks/node_modules
                      ./packages/duckdb-wasm/node_modules
                      ./packages/duckdb-wasm-shell/node_modules
                  key: ${{ runner.os }}-yarn-${{ hashFiles('./yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - uses: actions/download-artifact@v2
              with:
                  name: dataprep
                  path: ./target/release/
            - uses: actions/download-artifact@v2
              with:
                  name: tpch-dbgen
                  path: ./submodules/tpch-dbgen/dbgen/
            - uses: actions/download-artifact@v2
              with:
                  name: duckdb-shell
                  path: ./submodules/duckdb/build/Release/
            - uses: actions/download-artifact@v2
              with:
                  name: wasm-default
                  path: ./packages/duckdb-wasm/src/bindings/
            - uses: actions/download-artifact@v2
              with:
                  name: wasm-next
                  path: ./packages/duckdb-wasm/src/bindings/
            - uses: actions/download-artifact@v2
              with:
                  name: wasm-next-coi
                  path: ./packages/duckdb-wasm/src/bindings/

            - name: Build packages
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      mkdir -p ./lib/build/wasm/release ./reports
                      yarn install --frozen-lockfile
                      ./scripts/npm_version.sh
                      (cd ./submodules/duckdb && git fetch --tags)
                      yarn workspace @duckdb/duckdb-wasm build:release
                      yarn workspace @duckdb/benchmarks build

            - name: Run system benchmarks
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      yarn workspace @duckdb/benchmarks bench:system:scan:int
                      yarn workspace @duckdb/benchmarks bench:system:scan:text
                      yarn workspace @duckdb/benchmarks bench:system:sort:int
                      yarn workspace @duckdb/benchmarks bench:system:sum:int
                      yarn workspace @duckdb/benchmarks bench:system:sum:csv
                      yarn workspace @duckdb/benchmarks bench:system:regex
                      yarn workspace @duckdb/benchmarks bench:system:join:2
                      yarn workspace @duckdb/benchmarks bench:system:join:3

            - name: Upload benchmark reports
              uses: actions/upload-artifact@v2
              with:
                  name: benchmarks-simple
                  path: |
                      ./reports/benchmark_system_scan_int.json
                      ./reports/benchmark_system_scan_text.json
                      ./reports/benchmark_system_sort_int.json
                      ./reports/benchmark_system_sum_int.json
                      ./reports/benchmark_system_sum_csv.json
                      ./reports/benchmark_system_regex.json
                      ./reports/benchmark_system_join_2.json
                      ./reports/benchmark_system_join_3.json
                  retention-days: 1

    benchmarks_tpch_001:
        name: TPCH Scale Factor 0.01
        runs-on: ubuntu-latest
        needs:
            - dataprep
            - tpchgen
            - duckdb_shell
            - wasm_default
            - wasm_next
            - wasm_next_coi
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: 'recursive'
                  fetch-depth: 0

            - name: Cache node_modules
              uses: actions/cache@v2
              with:
                  path: |
                      ./node_modules
                      ./packages/benchmarks/node_modules
                      ./packages/duckdb-wasm/node_modules
                      ./packages/duckdb-wasm-shell/node_modules
                  key: ${{ runner.os }}-yarn-${{ hashFiles('./yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - uses: actions/download-artifact@v2
              with:
                  name: dataprep
                  path: ./target/release/
            - uses: actions/download-artifact@v2
              with:
                  name: tpch-dbgen
                  path: ./submodules/tpch-dbgen/dbgen/
            - uses: actions/download-artifact@v2
              with:
                  name: duckdb-shell
                  path: ./submodules/duckdb/build/Release/
            - uses: actions/download-artifact@v2
              with:
                  name: wasm-default
                  path: ./packages/duckdb-wasm/src/bindings/
            - uses: actions/download-artifact@v2
              with:
                  name: wasm-next
                  path: ./packages/duckdb-wasm/src/bindings/
            - uses: actions/download-artifact@v2
              with:
                  name: wasm-next-coi
                  path: ./packages/duckdb-wasm/src/bindings/

            - name: Build packages
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      mkdir -p ./lib/build/wasm/release ./reports
                      yarn install --frozen-lockfile
                      ./scripts/npm_version.sh
                      (cd ./submodules/duckdb && git fetch --tags)
                      yarn workspace @duckdb/duckdb-wasm build:release
                      yarn workspace @duckdb/benchmarks build

            - name: Generate benchmark data
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      ./scripts/generate_tpch_tbl.sh 0.01
                      ./scripts/generate_tpch_arrow.sh 0.01
                      ./scripts/generate_tpch_sqlite.sh 0.01
                      ./scripts/generate_tpch_duckdb.sh 0.01

            - name: Run TPCH benchmarks
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      yarn workspace @duckdb/benchmarks bench:system:tpch 0.01

            - name: Upload benchmark report
              uses: actions/upload-artifact@v2
              with:
                  name: benchmarks-tpch-001
                  path: |
                      ./reports/benchmark_system_tpch_001.json
                  retention-days: 1

    benchmarks_tpch_01:
        name: TPCH Scale Factor 0.1
        runs-on: ubuntu-latest
        needs:
            - dataprep
            - tpchgen
            - duckdb_shell
            - wasm_default
            - wasm_next
            - wasm_next_coi
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: 'recursive'
                  fetch-depth: 0

            - name: Cache node_modules
              uses: actions/cache@v2
              with:
                  path: |
                      ./node_modules
                      ./packages/benchmarks/node_modules
                      ./packages/duckdb-wasm/node_modules
                      ./packages/duckdb-wasm-shell/node_modules
                  key: ${{ runner.os }}-yarn-${{ hashFiles('./yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - uses: actions/download-artifact@v2
              with:
                  name: dataprep
                  path: ./target/release/
            - uses: actions/download-artifact@v2
              with:
                  name: tpch-dbgen
                  path: ./submodules/tpch-dbgen/dbgen/
            - uses: actions/download-artifact@v2
              with:
                  name: duckdb-shell
                  path: ./submodules/duckdb/build/Release/
            - uses: actions/download-artifact@v2
              with:
                  name: wasm-default
                  path: ./packages/duckdb-wasm/src/bindings/
            - uses: actions/download-artifact@v2
              with:
                  name: wasm-next
                  path: ./packages/duckdb-wasm/src/bindings/
            - uses: actions/download-artifact@v2
              with:
                  name: wasm-next-coi
                  path: ./packages/duckdb-wasm/src/bindings/

            - name: Build packages
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      mkdir -p ./lib/build/wasm/release ./reports
                      yarn install --frozen-lockfile
                      ./scripts/npm_version.sh
                      (cd ./submodules/duckdb && git fetch --tags)
                      yarn workspace @duckdb/duckdb-wasm build:release
                      yarn workspace @duckdb/benchmarks build

            - name: Generate benchmark data
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      ./scripts/generate_tpch_tbl.sh 0.1
                      ./scripts/generate_tpch_arrow.sh 0.1
                      ./scripts/generate_tpch_sqlite.sh 0.1
                      ./scripts/generate_tpch_duckdb.sh 0.1

            - name: Run TPCH benchmarks
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      yarn workspace @duckdb/benchmarks bench:system:tpch 0.1

            - name: Upload benchmark report
              uses: actions/upload-artifact@v2
              with:
                  name: benchmarks-tpch-01
                  path: |
                      ./reports/benchmark_system_tpch_01.json
                  retention-days: 1

    benchmarks_tpch_025:
        name: TPCH Scale Factor 0.25
        runs-on: ubuntu-latest
        needs:
            - dataprep
            - tpchgen
            - duckdb_shell
            - wasm_default
            - wasm_next
            - wasm_next_coi
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: 'recursive'
                  fetch-depth: 0

            - name: Cache node_modules
              uses: actions/cache@v2
              with:
                  path: |
                      ./node_modules
                      ./packages/benchmarks/node_modules
                      ./packages/duckdb-wasm/node_modules
                      ./packages/duckdb-wasm-shell/node_modules
                  key: ${{ runner.os }}-yarn-${{ hashFiles('./yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - uses: actions/download-artifact@v2
              with:
                  name: dataprep
                  path: ./target/release/
            - uses: actions/download-artifact@v2
              with:
                  name: tpch-dbgen
                  path: ./submodules/tpch-dbgen/dbgen/
            - uses: actions/download-artifact@v2
              with:
                  name: duckdb-shell
                  path: ./submodules/duckdb/build/Release/
            - uses: actions/download-artifact@v2
              with:
                  name: wasm-default
                  path: ./packages/duckdb-wasm/src/bindings/
            - uses: actions/download-artifact@v2
              with:
                  name: wasm-next
                  path: ./packages/duckdb-wasm/src/bindings/
            - uses: actions/download-artifact@v2
              with:
                  name: wasm-next-coi
                  path: ./packages/duckdb-wasm/src/bindings/

            - name: Build packages
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      mkdir -p ./lib/build/wasm/release ./reports
                      yarn install --frozen-lockfile
                      ./scripts/npm_version.sh
                      (cd ./submodules/duckdb && git fetch --tags)
                      yarn workspace @duckdb/duckdb-wasm build:release
                      yarn workspace @duckdb/benchmarks build

            - name: Generate benchmark data
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      ./scripts/generate_tpch_tbl.sh 0.25
                      ./scripts/generate_tpch_arrow.sh 0.25
                      ./scripts/generate_tpch_sqlite.sh 0.25
                      ./scripts/generate_tpch_duckdb.sh 0.25

            - name: Run TPCH benchmarks
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      yarn workspace @duckdb/benchmarks bench:system:tpch 0.25

            - name: Upload benchmark report
              uses: actions/upload-artifact@v2
              with:
                  name: benchmarks-tpch-025
                  path: |
                      ./reports/benchmark_system_tpch_025.json
                  retention-days: 1

    benchmarks_tpch_05:
        name: TPCH Scale Factor 0.5
        runs-on: ubuntu-latest
        needs:
            - dataprep
            - tpchgen
            - duckdb_shell
            - wasm_default
            - wasm_next
            - wasm_next_coi
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: 'recursive'
                  fetch-depth: 0

            - name: Cache node_modules
              uses: actions/cache@v2
              with:
                  path: |
                      ./node_modules
                      ./packages/benchmarks/node_modules
                      ./packages/duckdb-wasm/node_modules
                      ./packages/duckdb-wasm-shell/node_modules
                  key: ${{ runner.os }}-yarn-${{ hashFiles('./yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - uses: actions/download-artifact@v2
              with:
                  name: dataprep
                  path: ./target/release/
            - uses: actions/download-artifact@v2
              with:
                  name: tpch-dbgen
                  path: ./submodules/tpch-dbgen/dbgen/
            - uses: actions/download-artifact@v2
              with:
                  name: duckdb-shell
                  path: ./submodules/duckdb/build/Release/
            - uses: actions/download-artifact@v2
              with:
                  name: wasm-default
                  path: ./packages/duckdb-wasm/src/bindings/
            - uses: actions/download-artifact@v2
              with:
                  name: wasm-next
                  path: ./packages/duckdb-wasm/src/bindings/
            - uses: actions/download-artifact@v2
              with:
                  name: wasm-next-coi
                  path: ./packages/duckdb-wasm/src/bindings/

            - name: Build packages
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      mkdir -p ./lib/build/wasm/release ./reports
                      yarn install --frozen-lockfile
                      ./scripts/npm_version.sh
                      (cd ./submodules/duckdb && git fetch --tags)
                      yarn workspace @duckdb/duckdb-wasm build:release
                      yarn workspace @duckdb/benchmarks build

            - name: Generate benchmark data
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      ./scripts/generate_tpch_tbl.sh 0.5
                      ./scripts/generate_tpch_arrow.sh 0.5
                      ./scripts/generate_tpch_sqlite.sh 0.5
                      ./scripts/generate_tpch_duckdb.sh 0.5

            - name: Run TPCH benchmarks
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      yarn workspace @duckdb/benchmarks bench:system:tpch 0.5

            - name: Upload artifact
              uses: actions/upload-artifact@v2
              with:
                  name: benchmarks-tpch-05
                  path: |
                      ./reports/benchmark_system_tpch_05.json
                  retention-days: 1

    benchmarks_tpch_1:
        name: TPCH Scale Factor 1
        runs-on: ubuntu-latest
        needs:
            - dataprep
            - tpchgen
            - duckdb_shell
            - wasm_default
            - wasm_next
            - wasm_next_coi
        steps:
            - uses: actions/checkout@v2
              with:
                  submodules: 'recursive'
                  fetch-depth: 0

            - name: Cache node_modules
              uses: actions/cache@v2
              with:
                  path: |
                      ./node_modules
                      ./packages/benchmarks/node_modules
                      ./packages/duckdb-wasm/node_modules
                      ./packages/duckdb-wasm-shell/node_modules
                  key: ${{ runner.os }}-yarn-${{ hashFiles('./yarn.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-yarn-

            - uses: actions/download-artifact@v2
              with:
                  name: dataprep
                  path: ./target/release/
            - uses: actions/download-artifact@v2
              with:
                  name: tpch-dbgen
                  path: ./submodules/tpch-dbgen/dbgen/
            - uses: actions/download-artifact@v2
              with:
                  name: duckdb-shell
                  path: ./submodules/duckdb/build/Release/
            - uses: actions/download-artifact@v2
              with:
                  name: wasm-default
                  path: ./packages/duckdb-wasm/src/bindings/
            - uses: actions/download-artifact@v2
              with:
                  name: wasm-next
                  path: ./packages/duckdb-wasm/src/bindings/
            - uses: actions/download-artifact@v2
              with:
                  name: wasm-next-coi
                  path: ./packages/duckdb-wasm/src/bindings/

            - name: Build packages
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      mkdir -p ./lib/build/wasm/release ./reports
                      yarn install --frozen-lockfile
                      ./scripts/npm_version.sh
                      (cd ./submodules/duckdb && git fetch --tags)
                      yarn workspace @duckdb/duckdb-wasm build:release
                      yarn workspace @duckdb/benchmarks build

            - name: Generate benchmark data
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      ./scripts/generate_tpch_tbl.sh 1
                      ./scripts/generate_tpch_arrow.sh 1
                      ./scripts/generate_tpch_sqlite.sh 1
                      ./scripts/generate_tpch_duckdb.sh 1

            - name: Run TPCH benchmarks
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      yarn workspace @duckdb/benchmarks bench:system:tpch 1

            - name: Upload artifact
              uses: actions/upload-artifact@v2
              with:
                  name: benchmarks-tpch-1
                  path: |
                      ./reports/benchmark_system_tpch_1.json
                  retention-days: 1

    merge_benchmarks:
        name: Merge benchmark reports
        runs-on: ubuntu-latest
        needs:
            - dataprep
            - benchmarks_simple
            - benchmarks_tpch_001
            - benchmarks_tpch_01
            - benchmarks_tpch_025
            - benchmarks_tpch_05
            - benchmarks_tpch_1
        steps:
            - uses: actions/download-artifact@v2
              with:
                  name: benchmarks-simple
                  path: ./reports/
            - uses: actions/download-artifact@v2
              with:
                  name: benchmarks-tpch-001
                  path: ./reports/
            - uses: actions/download-artifact@v2
              with:
                  name: benchmarks-tpch-01
                  path: ./reports/
            - uses: actions/download-artifact@v2
              with:
                  name: benchmarks-tpch-025
                  path: ./reports/
            - uses: actions/download-artifact@v2
              with:
                  name: benchmarks-tpch-05
                  path: ./reports/
            - uses: actions/download-artifact@v2
              with:
                  name: benchmarks-tpch-1
                  path: ./reports/

            - name: Merge benchmark reports
              uses: duckdb/duckdb-wasm-ci-env@v0.4
              with:
                  script: |-
                      ./target/release/dataprep merge-benchmarks -r ./reports/

            - name: Deploy Web Shell
              if: github.ref == 'refs/heads/master'
              run: |
                  git config --global user.name 'github-actions[bot]'
                  git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
                  git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/$GITHUB_REPOSITORY
                  git fetch origin gh-pages
                  ./scripts/deploy_benchmarks.sh

            - name: Deploy GitHub Pages
              if: github.ref == 'refs/heads/master'
              uses: JamesIves/github-pages-deploy-action@4.1.5
              with:
                  branch: gh-pages
                  folder: ./.pages/reports
                  target-folder: ./reports
                  clean: false
                  single-commit: true
